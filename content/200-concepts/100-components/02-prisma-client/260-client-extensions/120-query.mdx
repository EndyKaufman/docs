---
title: 'Create custom Prisma Client queries'
metaTitle: 'Prisma Client extensions (Preview)'
metaDescription: 'Extend the functionality of Prisma Client'
tocDepth: 3
---

<TopBlock>

<Admonition type="warning">

This page is in draft.

</Admonition>

From version 4.7.0, you can use `query` [Prisma Client extensions](/concepts/components/prisma-client/client-extensions) to create custom Prisma Client queries. These custom queries return type-safe data and, like all Prisma Client extensions, [run in isolated instances](/concepts/components/prisma-client/client-extensions#client-instances).

You can use `query` extensions as an alternative to [middlewares](/concepts/components/prisma-client/middleware#performance-and-appropriate-use-cases). Unlike middlewares, `query` extensions give you user isolation and end-to-end type safety. [Learn more](#query-extensions-versus-middlewares).

Use the `$extends` [client-level method](/reference/api-reference/prisma-client-reference#client-methods) to create an _extended client_. An extended client is a forked variant of the standard Prisma Client with an extension applied. Use the `query` extension type to create custom queries to a specific model in your schema or to all models in your schema.

</TopBlock>

## Enable the preview feature

Before you create Prisma Client extensions, you must enable the `clientExtensions` feature flag in the `generator` block of your `schema.prisma` file, as follows:

```prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["clientExtensions"]
}
```

## Create custom queries

To create a custom query, use the following structure.

```ts
const xprisma = prisma.$extends({
  name?: 'name',
  query?: {
    user: { ... } //in this case, we add a query to the `user` model
  },
});
```

- `name`: an optional field that you can use to name the extension. This name appears in error logs.

In the following example, a custom query finds users who are older than 18 years:

```ts
const xprisma = prisma.$extends({
  query: {
    user: {
      async findMany({ model, action, args, data }) {
        // `where` can be `undefined`, so `args.where.age` could
        // fail. Therefore, we assign an object and backfill
        // the rest of the `where` clause:
        args.where = { age: { gt: 18 }, ...args.where }
        const users = await data
        return data
      },
    },
  },
})

await xprisma.user.findMany() // returns users whose age is greater than 18
```

The `query` object contains functions that map to the names of the [Prisma Client operations](/docs/reference/api-reference/prisma-client-reference#model-queries), such as `findUnique`, `findFirst`, `findMany`, `count`, and `create`.

In the above example, a call to `xprisma.user.findMany` triggers `query.user.findMany` on execution. Each callback receives a type-safe `{ model, operation, args, data }` object that describes a query as follows:

- `model`: the property name of the model whose query is being extended.

  In the above example, the `model` is a string of type `"User"`.

- `operation`: the property name of the operation being extended and executed.

  In the above example, the `operation` is a string of type `"findMany"`.

- `args`: the property that carries the specific query input information to be extended.

  This is a type-safe object that is meant to be mutated before the query happens. You can mutate any of the properties in `args`, except for `include` or `select`, because that would change the expected output type in such a way that it breaks type safety.

- `data`: the property that a result promise of the query that is being executed.

  You can `await` and then mutate this promise, because its value is also type-safe. TypeScript catches any unsafe mutations on that object. Doing `await data` is equivalent to calling `next(...)` in a middleware. You are free to mutate `args` before `then` is triggered, which leads to a more natural way of writing such extensions. `args` is fully type-safe, meaning that some properties are `readonly`, (like `includes` or `select`).

## Add a custom query to all models in your schema

To extend all models in your schema, use `$allmodels` instead of a specific model name.

For example:

```ts
const xprisma = prisma.$extends({
  query: {
    $allModels: {
      $allOperations({ model, operation, args, data }) {
        // handle all operations
        return data
      },
    },
  },
})
```

Note: Recursive wildcards cannot return values but can just modify the query itself.

- `$allModels`: an optional property that handles all models in a single extension.
- `$allOperations`: an optional property that handles all operations for a given model.

## Query extensions versus middlewares

You can use either Client query extensions or [middlewares](/concepts/components/prisma-client/middleware#performance-and-appropriate-use-cases) to hook into the query life-cycle and modify an incoming query or its result. Client extensions and middlewares differ in the following ways:

- Middlewares always apply globally to the same client. Client extensions are isolated, unless you deliberately combine them.
  - For example, in a row-level security (RLS) scenario, you can keep each user in an entirely separate client. With middlewares, all users are active in the same client.
- During application execution, with extensions you can choose from one or more extended clients, or the standard Prisma Client. With middlewares, you cannot choose which client to use, because there is only one global client.
- Extensions benefit from end-to-end type safety and inference, but middlewares don't.

You can use Prisma Client extensions in all scenarios where middlewares can be used.

### If you use query extensions and middlewares

** This section is TBC **

If you use `query` extensions and middlewares in your project, then the following priorities apply:

- In your application code, you must declare all your middlewares on the main Prisma Client instance before you declare your query extensions.
- You cannot instantiate middlewares (with `$use`) in extended clients. You can only instantiate middlewares in the original client.
- In situations where middlewares and `query` extensions execute, Prisma Client executes the middlewares before it executes the `query` extensions. Prisma Client executes the individual middlewares and `query` extensions in the order in which you instantiated them with `$use` or `$extends`.
